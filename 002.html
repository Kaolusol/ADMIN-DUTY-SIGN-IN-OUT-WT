<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAVE TOWN | Admin Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        
        /* แก้ไขจุดนี้: ให้ทุก element คำนวณขนาดรวม padding แล้ว */
        * { box-sizing: border-box; }

        body { font-family: 'Kanit', sans-serif; background: #0a0a0a; color: #eee; margin: 0; padding: 20px; overflow-x: hidden; }

        #clickLayer {
            position: fixed; inset: 0; background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            z-index: 20000; display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .start-btn {
            padding: 20px 60px; background: transparent; border: 2px solid #00d2ff; color: #00d2ff;
            font-size: 22px; font-weight: bold; border-radius: 50px; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .start-btn:hover { background: #00d2ff; color: #000; box-shadow: 0 0 30px #00d2ff; }

        .main-logo { position: fixed; top: 15px; left: 20px; z-index: 10005; }
        .main-logo img { height: 60px; width: auto; filter: drop-shadow(0 0 8px rgba(0, 210, 255, 0.5)); }

        .lang-switch { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; gap: 5px; }
        .lang-btn { background: #222; color: #fff; border: 1px solid #444; padding: 8px 12px; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 0.8rem; transition: 0.3s; }
        .lang-btn.active { background: #00d2ff; color: #000; border-color: #00d2ff; }

        #loginBox { position: fixed; inset: 0; background: #000; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
        .login-logo-big { height: 140px; width: auto; margin-bottom: 25px; filter: drop-shadow(0 0 15px rgba(0, 210, 255, 0.3)); }
        
        /* ปรับขนาด Card ให้พอดี */
        .card { background: #111; padding: 40px; border-radius: 25px; border: 1px solid #333; text-align: center; width: 100%; max-width: 360px; }
        
        /* แก้ไขจุดนี้: ช่องพิมพ์จะไม่เบี้ยวแล้ว */
        .login-input { 
            padding: 18px; 
            background: #000; 
            border: 2px solid #333; 
            color: #fff; 
            border-radius: 12px; 
            margin: 25px 0; 
            display: block; 
            width: 100%; 
            text-align: center; 
            font-size: 1.4rem; 
            font-family: 'Kanit';
            outline: none;
        }
        .login-input:focus { border-color: #00d2ff; }
        .btn-login { padding: 15px; background: #00d2ff; color: #000; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.1rem; }
        
        #dash { max-width: 1100px; margin: 90px auto 0 auto; display: none; }
        .header { background: #161616; padding: 25px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-left: 6px solid #00d2ff; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; }
        th { background: #1a1a1a; color: #00d2ff; padding: 20px; text-align: left; text-transform: uppercase; font-size: 0.9rem; }
        td { background: #111; padding: 18px 20px; border-top: 1px solid #222; border-bottom: 1px solid #222; }
        td:first-child { border-radius: 12px 0 0 12px; border-left: 1px solid #222; }
        td:last-child { border-radius: 0 12px 12px 0; border-right: 1px solid #222; }
        
        .status-on { color: #00ff88; font-weight: bold; }
        .status-off { color: #ff4d4d; font-weight: bold; }
        .btn-action { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; margin-left: 10px; font-family: 'Kanit'; transition: 0.2s; }

        .status-box { position: fixed; bottom: 20px; left: 20px; z-index: 10001; pointer-events: none; }
        #t-status { font-size: 11px; font-weight: bold; opacity: 0.8; }
    </style>
</head>
<body>

<div id="clickLayer">
    <img src="WT.logo.png" style="height: 100px; margin-bottom: 30px;">
    <button class="start-btn" onclick="activateSystem()">START DASHBOARD</button>
</div>

<div class="main-logo"><img src="WT.logo.png"></div>

<div class="lang-switch">
    <button type="button" class="lang-btn active" id="btn-th" onclick="setLanguage('th')">TH</button>
    <button type="button" class="lang-btn" id="btn-en" onclick="setLanguage('en')">EN</button>
</div>

<div id="loginBox">
    <img src="WT.logo.png" class="login-logo-big">
    <form class="card" onsubmit="handleLogin(event)">
        <p id="t-login-sub" style="color:#666; margin: 0;">กรุณาระบุหน่วยงาน</p>
        <input type="text" id="pass" class="login-input" placeholder="..." autocomplete="off">
        <button type="submit" id="t-login-btn" class="btn-login">ENTER SYSTEM</button>
        <p id="errorMsg" style="color: #ff4d4d; margin-top: 15px; font-size: 0.85rem; min-height: 1.2em;"></p>
    </form>
</div>

<audio id="mainMusic" loop><source src="final.mp3" type="audio/mpeg"></audio>

<div id="dash">
    <div class="header">
        <h2 style="margin:0;"><span id="t-dash-title">ตารางเวลา</span> (<span id="roleText"></span>)</h2>
        <div>
            <button id="t-btn-refresh" class="btn-action" style="background:#27ae60" onclick="loadData()">REFRESH</button>
            <button id="t-btn-reset" class="btn-action" style="background:#c0392b; display:none;" onclick="resetData()">RESET ALL</button>
            <button id="t-btn-logout" class="btn-action" style="background:#333" onclick="location.reload()">LOGOUT</button>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th id="t-h-id">ID</th>
                <th id="t-h-dept">DEPARTMENT</th>
                <th id="t-h-time">TIME</th>
                <th id="t-h-status">STATUS</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div class="status-box"><span id="t-status" style="color:#ffb300;">AUDIO: WAITING...</span></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDVCzhpm7-krLUntUMDCI9ZdcKJOolMw8c",
        authDomain: "admin-duty-sign-inout-wt.firebaseapp.com",
        databaseURL: "https://admin-duty-sign-inout-wt-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "admin-duty-sign-inout-wt",
        storageBucket: "admin-duty-sign-inout-wt.firebasestorage.app",
        messagingSenderId: "676786771738",
        appId: "1:676786771738:web:22312dc2df3daa73333ea3",
        measurementId: "G-35ZMNBVD9T"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const audio = document.getElementById('mainMusic');
    const statusText = document.getElementById('t-status');
    let userRole = "";
    let currentLang = 'th';

    const translations = {
        th: { loginSub: "กรุณาระบุชื่อหน่วยงาน", loginBtn: "เข้าสู่ระบบ", dashTitle: "ระบบตรวจสอบเวลา", btnRefresh: "รีเฟรช", btnReset: "ล้างข้อมูล", btnLogout: "ออก", hId: "รหัส", hDept: "หน่วยงาน", hTime: "เวลา", hStatus: "สถานะ", errPass: "ไม่พบหน่วยงาน!", confirmReset: "ล้างข้อมูลทั้งหมด?" },
        en: { loginSub: "ENTER AGENCY NAME", loginBtn: "LOGIN", dashTitle: "STAFF MONITOR", btnRefresh: "REFRESH", btnReset: "RESET", btnLogout: "LOGOUT", hId: "ID", hDept: "DEPT", hTime: "TIME", hStatus: "STATUS", errPass: "Invalid!", confirmReset: "Clear all records?" }
    };

    function activateSystem() {
        audio.play().then(() => {
            statusText.innerText = "AUDIO: PLAYING"; statusText.style.color = "#00ff88";
            document.getElementById('clickLayer').style.display = "none";
            document.getElementById('loginBox').style.display = "flex";
            document.getElementById('pass').focus();
        });
    }

    window.addEventListener('keydown', (e) => {
        if (["INPUT", "SELECT"].includes(document.activeElement.tagName)) return;
        if (e.key.toLowerCase() === 'm' || e.key === 'ท') {
            audio.muted = !audio.muted;
            statusText.innerText = audio.muted ? "AUDIO: MUTED" : "AUDIO: PLAYING";
            statusText.style.color = audio.muted ? "#ff4d4d" : "#00ff88";
        }
        if (e.key.toLowerCase() === 'q' && userRole !== "") location.reload();
    });

    function handleLogin(event) {
        event.preventDefault();
        const p = document.getElementById('pass').value.trim().toUpperCase();
        const codes = {
            "DOT": "DOT", "ช่าง": "DOT", 
            "MOD": "MOD", "มอด": "MOD", 
            "PD": "POLICE", "POLICE": "POLICE", "ตำรวจ": "POLICE",
            "FR": "FIRE/MEDIC", "FIRE": "FIRE/MEDIC", "MEDIC": "FIRE/MEDIC",
            "WT": "WAVE TOWN", "WAVETOWN": "WAVE TOWN", "เวฟทาวน์": "WAVE TOWN",
            "COURT": "COURT", "ศาล": "COURT"
        };
        if (codes[p]) {
            userRole = codes[p];
            document.getElementById('loginBox').style.display = "none";
            document.getElementById('dash').style.display = "block";
            document.getElementById('roleText').innerText = userRole;
            if (userRole === "WAVE TOWN") document.getElementById('t-btn-reset').style.display = "inline-block";
            loadData();
        } else {
            document.getElementById('errorMsg').innerText = translations[currentLang].errPass;
        }
    }

    function loadData() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Loading...</td></tr>";
        db.ref('attendance').on('value', (snapshot) => {
            const data = snapshot.val(); tbody.innerHTML = "";
            if (!data) return;
            Object.values(data).forEach(staff => {
                let show = false;
                const d = staff.dept.toUpperCase();
                const role = userRole.toUpperCase();
                if (role === "WAVE TOWN" || role === "MOD") show = true;
                else if (role === "FIRE/MEDIC" && (d === "FIRE/MEDIC" || d === "FIRE" || d === "MEDIC")) show = true;
                else if (role === d) show = true;

                if (show) {
                    const isOn = staff.status.includes("On") || staff.status.includes("เข้า");
                    tbody.innerHTML += `<tr>
                        <td><b>${staff.id}</b></td>
                        <td>${staff.dept}</td>
                        <td>${staff.time}</td>
                        <td class="${isOn ? 'status-on' : 'status-off'}">${staff.status}</td>
                    </tr>`;
                }
            });
        });
    }

    function resetData() { if (confirm(translations[currentLang].confirmReset)) db.ref('attendance').remove(); }
    
    function setLanguage(lang) { 
        currentLang = lang; 
        document.getElementById('btn-th').classList.toggle('active', lang === 'th');
        document.getElementById('btn-en').classList.toggle('active', lang === 'en');
        updateUI(); 
    }

    function updateUI() {
        const t = translations[currentLang];
        document.getElementById('t-login-sub').innerText = t.loginSub;
        document.getElementById('t-login-btn').innerText = t.loginBtn;
        document.getElementById('t-dash-title').innerText = t.dashTitle;
        document.getElementById('t-btn-refresh').innerText = t.btnRefresh;
        document.getElementById('t-btn-reset').innerText = t.btnReset;
        document.getElementById('t-btn-logout').innerText = t.btnLogout;
        document.getElementById('t-h-id').innerText = t.hId;
        document.getElementById('t-h-dept').innerText = t.hDept;
        document.getElementById('t-h-time').innerText = t.hTime;
        document.getElementById('t-h-status').innerText = t.hStatus;
    }
    updateUI();
</script>
</body>
</html>