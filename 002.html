<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAVE TOWN | Admin Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        * { box-sizing: border-box; }
        body { font-family: 'Kanit', sans-serif; background: #0a0a0a; color: #eee; margin: 0; padding: 20px; overflow-x: hidden; }
        
        /* สไตล์หน้าแรก */
        #clickLayer { position: fixed; inset: 0; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); z-index: 20000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .start-btn { padding: 20px 60px; background: transparent; border: 2px solid #00d2ff; color: #00d2ff; font-size: 22px; font-weight: bold; border-radius: 50px; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 2px; }
        .start-btn:hover { background: #00d2ff; color: #000; box-shadow: 0 0 30px #00d2ff; }
        
        .main-logo { position: fixed; top: 15px; left: 20px; z-index: 10005; }
        .main-logo img { height: 60px; width: auto; filter: drop-shadow(0 0 8px rgba(0, 210, 255, 0.5)); }

        /* หน้า Login */
        #loginBox { position: fixed; inset: 0; background: #000; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
        .login-logo-big { height: 140px; width: auto; margin-bottom: 25px; filter: drop-shadow(0 0 15px rgba(0, 210, 255, 0.3)); }
        .card { background: #111; padding: 40px; border-radius: 25px; border: 1px solid #333; text-align: center; width: 100%; max-width: 380px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-input { padding: 18px; background: #000; border: 2px solid #333; color: #fff; border-radius: 12px; margin: 25px 0; display: block; width: 100%; text-align: center; font-size: 1.4rem; font-family: 'Kanit'; outline: none; transition: 0.3s; }
        .login-input:focus { border-color: #00d2ff; box-shadow: 0 0 15px rgba(0, 210, 255, 0.2); }
        .btn-login { padding: 15px; background: #00d2ff; color: #000; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.1rem; transition: 0.3s; }
        .btn-login:hover { background: #00e5ff; transform: translateY(-2px); }

        /* หน้า Dashboard */
        #dash { max-width: 1200px; margin: 100px auto 0 auto; display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .header { background: #161616; padding: 25px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-left: 6px solid #00d2ff; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .sv-control { background: #1a1a1a; padding: 15px 25px; border-radius: 15px; margin-bottom: 25px; display: none; gap: 15px; align-items: center; border: 1px solid #333; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { background: transparent; color: #00d2ff; padding: 15px 20px; text-align: left; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; }
        td { background: #111; padding: 20px; border-top: 1px solid #222; border-bottom: 1px solid #222; transition: 0.2s; }
        tr:hover td { background: #161616; border-color: #444; }
        td:first-child { border-radius: 15px 0 0 15px; border-left: 1px solid #222; }
        td:last-child { border-radius: 0 15px 15px 0; border-right: 1px solid #222; }

        .status-on { color: #00ff88; font-weight: bold; text-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .status-off { color: #ff4d4d; font-weight: bold; }
        
        .btn-action { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; margin-left: 10px; font-family: 'Kanit'; transition: 0.3s; }
        .btn-action:hover { opacity: 0.8; transform: translateY(-1px); }

        .status-box { position: fixed; bottom: 20px; left: 20px; z-index: 10001; }
        #t-status { font-size: 11px; font-weight: bold; letter-spacing: 1px; }

        .lang-switch { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; gap: 5px; }
        .lang-btn { background: #222; color: #fff; border: 1px solid #444; padding: 8px 12px; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 0.8rem; transition: 0.3s; }
        .lang-btn.active { background: #00d2ff; color: #000; border-color: #00d2ff; }
    </style>
</head>
<body>

<div id="clickLayer">
    <img src="WT.logo.png" style="height: 100px; margin-bottom: 30px;">
    <button class="start-btn" onclick="activateSystem()">START DASHBOARD</button>
</div>

<div class="main-logo"><img src="WT.logo.png"></div>

<div class="lang-switch">
    <button type="button" class="lang-btn active" id="btn-th" onclick="setLanguage('th')">TH</button>
    <button type="button" class="lang-btn" id="btn-en" onclick="setLanguage('en')">EN</button>
</div>

<div id="loginBox">
    <img src="WT.logo.png" class="login-logo-big">
    <form class="card" onsubmit="handleLogin(event)">
        <p id="t-login-sub" style="color:#666; margin: 0; font-size: 0.9rem;">กรุณาระบุหน่วยงานเพื่อเข้าถึงข้อมูล</p>
        <input type="text" id="pass" class="login-input" placeholder="หน่วยงาน..." autocomplete="off">
        <button type="submit" id="t-login-btn" class="btn-login">LOGIN TO SYSTEM</button>
        <p id="errorMsg" style="color: #ff4d4d; margin-top: 15px; font-size: 0.85rem; min-height: 1.2em;"></p>
    </form>
</div>

<audio id="mainMusic" loop><source src="final.mp3" type="audio/mpeg"></audio>

<div id="dash">
    <div id="svAdmin" class="sv-control">
        <span style="font-weight:bold; color: #888;">SERVER MANAGER:</span>
        <button class="btn-action" style="background:#27ae60;" onclick="setServer('open')">เปิดเซิร์ฟ (OPEN)</button>
        <button class="btn-action" style="background:#c0392b;" onclick="setServer('close')">ปิดเซิร์ฟ (CLOSE ALL)</button>
        <span id="svStatusLabel" style="margin-left:auto; font-size:12px; font-weight: bold;"></span>
    </div>

    <div class="header">
        <h2 style="margin:0;"><span id="t-dash-title">ตารางเวลา</span> (<span id="roleText"></span>)</h2>
        <div>
            <button class="btn-action" style="background:#2ecc71" onclick="loadData()">REFRESH</button>
            <button class="btn-action" style="background:#e74c3c; display:none;" id="btnReset" onclick="resetData()">RESET ALL</button>
            <button class="btn-action" style="background:#333" onclick="logout()">LOGOUT (Q)</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th id="t-h-id">ID</th>
                <th id="t-h-dept">DEPARTMENT</th>
                <th id="t-h-time">LAST ACTION</th>
                <th id="t-h-status">STATUS</th>
                <th id="t-h-total">TOTAL TIME (LIVE)</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div class="status-box" id="t-status" style="color:#ffb300;">AUDIO: WAITING...</div>

<script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyDVCzhpm7-krLUntUMDCI9ZdcKJOolMw8c",
        authDomain: "admin-duty-sign-inout-wt.firebaseapp.com",
        databaseURL: "https://admin-duty-sign-inout-wt-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "admin-duty-sign-inout-wt",
        storageBucket: "admin-duty-sign-inout-wt.firebasestorage.app",
        messagingSenderId: "676786771738",
        appId: "1:676786771738:web:22312dc2df3daa73333ea3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const audio = document.getElementById('mainMusic');
    const statusText = document.getElementById('t-status');
    let userRole = "";
    let attendanceData = {};
    let currentLang = 'th';

    const translations = {
        th: { loginSub: "กรุณาระบุชื่อหน่วยงานเพื่อเข้าถึงข้อมูล", loginBtn: "เข้าสู่ระบบ", dashTitle: "ระบบตรวจสอบเวลาพนักงาน", hId: "รหัส", hDept: "หน่วยงาน", hTime: "เวลาล่าสุด", hStatus: "สถานะ", hTotal: "เวลารวม (Real-time)" },
        en: { loginSub: "Please enter agency name to access data", loginBtn: "LOGIN TO SYSTEM", dashTitle: "STAFF MONITORING SYSTEM", hId: "ID", hDept: "DEPT", hTime: "LAST TIME", hStatus: "STATUS", hTotal: "TOTAL TIME (LIVE)" }
    };

    function activateSystem() {
        audio.play().then(() => {
            statusText.innerText = "AUDIO: PLAYING";
            statusText.style.color = "#00ff88";
            document.getElementById('clickLayer').style.display = "none";
            document.getElementById('loginBox').style.display = "flex";
            document.getElementById('pass').focus();
        }).catch(() => {
            // ถ้า Autoplay โดนบล็อก ให้ข้ามไปหน้า Login เลย
            document.getElementById('clickLayer').style.display = "none";
            document.getElementById('loginBox').style.display = "flex";
        });
    }

    // --- แก้ไขระบบปุ่มลัด (ท/M และ Q) ---
    window.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        
        // ถ้ากำลังพิมพ์ในช่อง Input ไม่ให้ทำงาน (ยกเว้นปุ่ม Enter)
        if (document.activeElement.tagName === 'INPUT' && key !== 'enter') return;

        // กด Q เพื่อ Logout
        if (key === 'q' || key === 'ๆ') {
            if (document.getElementById('dash').style.display === "block") {
                logout();
            }
        }

        // กด M เพื่อปิด/เปิดเสียง
        if (key === 'm' || key === 'ท') {
            e.preventDefault();
            audio.muted = !audio.muted;
            statusText.innerText = audio.muted ? "AUDIO: MUTED" : "AUDIO: PLAYING";
            statusText.style.color = audio.muted ? "#ff4d4d" : "#00ff88";
        }
    });

    function logout() {
        location.reload();
    }

    function handleLogin(e) {
        e.preventDefault();
        const p = document.getElementById('pass').value.trim().toUpperCase();
        const codes = { "DOT": "DOT", "MOD": "MOD", "PD": "POLICE", "POLICE": "POLICE", "WT": "WAVE TOWN", "WAVETOWN": "WAVE TOWN" };
        
        if (codes[p]) {
            userRole = codes[p];
            document.getElementById('loginBox').style.display = "none";
            document.getElementById('dash').style.display = "block";
            document.getElementById('roleText').innerText = userRole;
            
            if (userRole === "WAVE TOWN" || userRole === "MOD") {
                document.getElementById('svAdmin').style.display = "flex";
                if (userRole === "WAVE TOWN") document.getElementById('btnReset').style.display = "inline-block";
            }
            loadData();
        } else {
            document.getElementById('errorMsg').innerText = "❌ รหัสหน่วยงานไม่ถูกต้อง!";
        }
    }

    function loadData() {
        db.ref('attendance').on('value', (snap) => {
            attendanceData = snap.val() || {};
            renderTable();
        });
    }

    function setServer(status) {
        db.ref('server/status').set(status);
        if (status === 'close') {
            Object.values(attendanceData).forEach(staff => {
                if (staff.status === 'Duty On') {
                    const ts = Date.now();
                    const total = (staff.totalMinutes || 0) + Math.floor((ts - staff.lastOnTimestamp) / 60000);
                    db.ref('attendance/' + staff.id).update({
                        status: 'Duty Off (System Close)',
                        totalMinutes: total,
                        time: new Date().toLocaleTimeString('th-TH')
                    });
                }
            });
        }
    }

    db.ref('server/status').on('value', snap => {
        const s = snap.val();
        const lbl = document.getElementById('svStatusLabel');
        lbl.innerText = s === 'open' ? "● SERVER: ONLINE" : "○ SERVER: OFFLINE";
        lbl.style.color = s === 'open' ? "#00ff88" : "#ff4d4d";
    });

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        const now = Date.now();

        Object.values(attendanceData).forEach(staff => {
            let show = (userRole === "WAVE TOWN" || userRole === "MOD" || userRole === staff.dept.toUpperCase());
            if (!show) return;

            const isOn = staff.status === 'Duty On';
            let currentTotal = staff.totalMinutes || 0;
            if (isOn && staff.lastOnTimestamp) {
                currentTotal += Math.floor((now - staff.lastOnTimestamp) / 60000);
            }

            const h = Math.floor(currentTotal / 60);
            const m = currentTotal % 60;

            tbody.innerHTML += `<tr>
                <td><b>${staff.id}</b></td>
                <td><span style="background:#222; padding:5px 10px; border-radius:5px; font-size:0.8rem;">${staff.dept}</span></td>
                <td>${staff.time}</td>
                <td class="${isOn ? 'status-on' : 'status-off'}">${staff.status}</td>
                <td style="color:#00d2ff; font-weight:bold;">${h} ชม. ${m} นาที</td>
            </tr>`;
        });
    }

    setInterval(renderTable, 30000); // อัปเดตเวลาหน้าจอทุก 30 วิ

    function setLanguage(lang) {
        currentLang = lang;
        document.getElementById('btn-th').classList.toggle('active', lang === 'th');
        document.getElementById('btn-en').classList.toggle('active', lang === 'en');
        const t = translations[lang];
        document.getElementById('t-login-sub').innerText = t.loginSub;
        document.getElementById('t-login-btn').innerText = t.loginBtn;
        document.getElementById('t-dash-title').innerText = t.dashTitle;
        document.getElementById('t-h-id').innerText = t.hId;
        document.getElementById('t-h-dept').innerText = t.hDept;
        document.getElementById('t-h-time').innerText = t.hTime;
        document.getElementById('t-h-status').innerText = t.hStatus;
        document.getElementById('t-h-total').innerText = t.hTotal;
    }

    function resetData() { if (confirm("ยืนยันการล้างข้อมูลพนักงานทั้งหมด?")) db.ref('attendance').remove(); }
</script>
</body>
</html>
